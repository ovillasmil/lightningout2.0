<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Lightning Out 2.0 – Client-Side Attempt</title>
</head>
<body>
  <div id="status">Starting...</div>

  <!-- Fallback: Config for silent auth -->
  <lightning-out-config id="loConfig" 
    frontdoor-url="https://pghsa--full.sandbox.my.salesforce.com">
  </lightning-out-config>

  <lightning-out-application components="c-gp-sfdc-out"></lightning-out-application>
  <c-gp-sfdc-out case-id="81863" id="sfdcCmp"></c-gp-sfdc-out>

  <script>
    // ⚠️ NEVER hardcode these in real apps
    const CLIENT_ID = 'YOUR_CONNECTED_APP_CONSUMER_KEY';       // ← Replace with real value
    const CLIENT_SECRET = 'YOUR_CONNECTED_APP_SECRET';         // ← Replace with real value
    const INSTANCE_URL = 'https://pghsa--full.sandbox.my.salesforce.com';

    async function tryServerlessAuth() {
      document.getElementById('status').textContent = 'Trying direct auth (will likely fail due to CORS)...';

      try {
        // This will FAIL in browser due to CORS and missing proxy
        const response = await fetch(`${INSTANCE_URL}/services/oauth2/lightningoutsingleaccess`, {
          method: 'POST',
          mode: 'cors', // still blocked by Salesforce CORS policy
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            client_id: CLIENT_ID,
            client_secret: CLIENT_SECRET
          })
        });

        const data = await response.json();
        if (data.frontdoor_url) {
          document.getElementById('loConfig').setAttribute('frontdoor-url', data.frontdoor_url);
          document.getElementById('status').textContent = 'Auth successful! Loading component...';
          loadLightningScript();
          return;
        }
      } catch (e) {
        console.warn('Direct auth failed (expected):', e.message);
      }

      // ✅ FALL BACK to silent auth (the only working client-side method)
      document.getElementById('status').textContent = 'Falling back to silent auth (ensure you are logged in to Salesforce)...';
      loadLightningScript();
    }

    function loadLightningScript() {
      const script = document.createElement('script');
      script.src = 'https://pghsa--full.sandbox.my.salesforce.com/lightning/lightning.out.latest/index.iife.prod.js';
      script.onload = () => {
        setTimeout(() => {
          const cmp = document.getElementById('sfdcCmp');
          if (cmp && cmp.shadowRoot) {
            document.getElementById('status').textContent = '✅ Component loaded!';
          } else {
            document.getElementById('status').textContent = '⚠️ Check: Are you logged into Salesforce in this browser?';
          }
        }, 3000);
      };
      document.head.appendChild(script);
    }

    // Start
    tryServerlessAuth();
  </script>
</body>
</html>
